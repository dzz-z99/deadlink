<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model with API-Driven Shape Key</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.150.0/build/three.module.js';
        import { GLTFLoader } from 'https://unpkg.com/three@0.150.0/examples/jsm/loaders/GLTFLoader.js';
        import { OrbitControls } from 'https://unpkg.com/three@0.150.0/examples/jsm/controls/OrbitControls.js';

        // Setup scene, camera, renderer
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Add lighting
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(0, 1, 1).normalize();
        scene.add(light);

        // Set camera initial position
        camera.position.set(0, 1, 3);

        // Add OrbitControls for zooming
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.25;
        controls.enableZoom = true;

        // Load GLTF model
        const loader = new GLTFLoader();
        loader.load('models/06_ShapeKey_TEST_Disc.glb', function(gltf) {
            const model = gltf.scene;
            scene.add(model);

            const cylinder001 = model.getObjectByName('cylinder.001');
            if (cylinder001 && cylinder001.morphTargetInfluences) {
                // Fetch data from API and normalize the value
                fetch('https://script.googleusercontent.com/macros/echo?user_content_key=H_r5uwp_XlijZ5TzbGcqHMilMwepE3pdSDLRLBSeLeYcARL7_ucFGrGbex0-gXZwduiWpfM1y7nlt_WHsld6cLC4aXPLFWg5m5_BxDlH2jW0nuo2oDemN9CCS2h10ox_1xSncGQajx_ryfhECjZEnLOhP_Yv2g7cdzrEvHyGSNEVukO7LcfqB0E5Sla7ueR41jq5zjZBMj-uZS5JNTN58D-EWxpy17moBNLfIDa8OkjcGI7lhJ_ZLw&lib=MSykVP-T6JpMcNQKt2t8MtLlZCQc5u2io')
                    .then(response => response.json())
                    .then(data => {
                        const apiValue = data[0]["Assigned Value"];
                        // Normalize the API value to the 0-1 range for the DiscSize shape key
                        const normalizedValue = (apiValue - 0) / (5 - 0);
                        // Set the shape key value (DiscSize)
                        cylinder001.morphTargetInfluences[0] = normalizedValue;
                    })
                    .catch(error => console.error('Error fetching API data:', error));
            }

            animate();
        }, undefined, function(error) {
            console.error('Error loading the GLB model:', error);
        });

        // Handle resizing
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>

